define("rpc.btapp",["jquery","underscore"],function(e,t){var n=function(e,t){if(!e)throw t},r=function(e){this.port=e.port,this.callbacks={}};return r.prototype.storeCallbackFunction=function(e){e=e||function(){};var t="bt_";for(var n=0;n<20||t in this.callbacks;n++)t+=Math.floor(Math.random()*10);return this.callbacks[t]=e,t},r.isRPCFunctionSignature=function(e){return n(typeof e=="string","do not check function signature of non-strings"),e.match(/\[native function\](\([^\)]*\))+/)||e.match(/\[nf\](\([^\)]*\))+/)},r.isJSFunctionSignature=function(e){return n(typeof e=="string","do not check function signature of non-strings"),e.match(/\[nf\]bt_/)},r.prototype.getStoredFunction=function(e){n(r.isJSFunctionSignature(e),'only store functions that match the pattern "[nf]bt_*"');var t=e.substring(4);return n(t in this.callbacks,"trying to get a function with a key that is not recognized"),this.callbacks[t]},r.validateArguments=function(e,r){n(typeof e=="string","expected functionValue to be a string"),n(typeof r=="object","expected variables to be an object");var i=e.match(/\([^\)]*\)/g);return t.any(i,function(e){return e=e.match(/\w+/g)||[],e.length===r.length&&t.all(e,function(e,t){if(typeof r[t]=="undefined")throw"client functions do not support undefined arguments";if(r[t]===null)return!0;switch(e){case"number":case"string":case"boolean":return typeof r[t]===e;case"unknown":return!0;case"array":return typeof r[t]=="object";case"dispatch":return typeof r[t]=="object"||typeof r[t]=="function";default:throw"there is an invalid type in the function signature exposed by the client"}})})},r.prototype.convertCallbackFunctionArgs=function(e){t.each(e,function(t,n){typeof t=="function"?e[n]=this.storeCallbackFunction(t):typeof t=="object"&&t&&this.convertCallbackFunctionArgs(t)},this)},r.prototype.createFunction=function(i,s,o){n(i,"cannot create a function without a session id");var u=t.bind(function(){var u=[],a;for(a=0;a<arguments.length;a++)u.push(arguments[a]);n(r.validateArguments.call(this,o,u),"arguments do not match any of the function signatures exposed by the client"),this.convertCallbackFunctionArgs(u);var f=new e.Deferred,l=t.bind(function(e){t.each(s,function(t){var n=decodeURIComponent(t);typeof e!="undefined"&&(e=e[n])});if(typeof e=="undefined")f.reject("return value parsing error "+JSON.stringify(e));else if(typeof e=="string"&&r.isJSFunctionSignature(e)){var i=this.getStoredFunction(e);n(i,"the client is returning a function name that does not exist"),f.resolve(i)}else f.resolve(e)},this),c=function(e){f.reject(e)};return this.query({type:"function",path:JSON.stringify(s),args:JSON.stringify(u),session:i}).done(l).fail(c),f},this);return u.valueOf=function(){return o},u},r.prototype.query=function(r){var i=!1,s=new e.Deferred;n(r.type==="update"||r.type==="state"||r.type==="function"||r.type==="disconnect",'the query type must be either "update", "state", or "function"'),r.hostname=window.location.hostname||window.location.pathname;var o=t.bind(function(e){if(e==="invalid request")throw"pairing occured with a torrent client that does not support the btapp api";typeof e!="object"||"error"in e?s.reject():s.resolve(e)},this);return this.sendQuery(r).done(function(){i||o.apply(this,arguments)}).fail(function(){i||s.reject.apply(this,arguments)}),s.abort=function(){i=!0},s},r.prototype.sendQuery=function(e){var t="http://localhost.bittorrent.com:"+this.port+"/btapp/",n=require("btapp");return n.ajax({url:t,data:e,dataType:"jsonp"})},r}),define("base.btapp",["require","backbone","underscore","jquery","rpc.btapp"],function(e,t,n,r,i){var s=function(e,t){if(!e)throw t},o=function(e){return n.isObject(e)&&!n.isArray(e)&&r.isEmptyObject(e)},u={initialize:function(){this.initializeValues()},clearRemoteProcedureCalls:function(){var e=n.keys(this.bt||{});for(var t=0;t<e.length;t++){var r=e[t];delete this.bt[r],delete this[r]}this.bt={}},initializeValues:function(){this.path=null,this.session=null,this.clearRemoteProcedureCalls()},updateRemoveFunctionState:function(e){s(e in this.bt,"trying to remove a function that does not exist"),this.trigger("remove:bt:"+e),this.trigger("remove:bt",this.bt[e],e),delete this.bt[e];if(e==="keys"||e==="get"||e==="set"||e==="unset"||e==="length")return;return s(e in this,'trying to remove the function "'+e+'", which does not exist in the prototype of this object'),this.trigger("remove:"+e),delete this[e],{}},updateRemoveObjectState:function(e,t,n,r,i){var o={},u=this.get(i);return s(u,"trying to remove a model that does not exist"),s("updateState"in u,"trying to remove an object that does not extend BtappBase"),u.updateState(e,t,n,r),u.isEmpty()&&(o[i]=u,u.trigger("destroy")),o},updateRemoveElementState:function(e,t,r,s,o){var u=n.clone(o||[]);u.push(s);if(s==="all")return this.updateState(this.session,t,r,u);if(n.isNull(r))return this.updateRemoveAttributeState(s,r);if(n.isObject(r)&&!n.isArray(r))return this.updateRemoveObjectState(e,t,r,u,s);if(n.isString(r)&&i.isRPCFunctionSignature(r))return this.updateRemoveFunctionState(s);if(n.isString(r)&&i.isJSFunctionSignature(r))return this.updateRemoveAttributeState(s,this.rpc.getStoredFunction(r));if(s!=="id")return this.updateRemoveAttributeState(s,r)},updateRemoveState:function(e,t,r,i){var s={};for(var o in r)t[o]===undefined&&n.extend(s,this.updateRemoveElementState(e,t[o],r[o],o,i));return s},updateAddFunctionState:function(e,t,r,i){var o=n.clone(r||[]);o.push(i);var u=this.rpc.createFunction(e,o,t);return s(!(i in this.bt),"trying to add a function that already exists"),this.bt[i]=u,i!=="keys"&&i!=="get"&&i!=="set"&&i!=="unset"&&i!=="length"&&(s(!(i in this),'trying to add the function "'+i+'", which already exists in the prototype of this object'),this[i]=u,this.trigger("add:"+i)),this.trigger("add:bt:"+i),this.trigger("add:bt",this.bt[i],i),{}},updateAddObjectState:function(t,n,r,i,s){var o={},u=this.get(s);if(u===undefined){var a=e("collection.btapp"),f=e("model.btapp");a.prototype.verifyPath(i)?u=new a:u=new f({id:s}),u.path=i,u.rpc=this.rpc,o[s]=u}return u.updateState(this.session,n,r,i),o},updateAddElementState:function(e,t,r,s,o){var u=n.clone(o||[]);return u.push(s),n.isString(r)&&i.isJSFunctionSignature(r)&&(r=this.rpc.getStoredFunction(r)),s==="all"?this.updateState(this.session,t,r,u):n.isNull(t)?this.updateAddAttributeState(e,t,r,u,s):n.isObject(t)&&!n.isArray(t)?this.updateAddObjectState(e,t,r,u,s):n.isString(t)&&i.isRPCFunctionSignature(t)?this.updateAddFunctionState(e,t,o,s):n.isString(t)&&i.isJSFunctionSignature(t)?this.updateAddAttributeState(e,this.rpc.getStoredFunction(t),r,o,s):this.updateAddAttributeState(e,t,r,u,s)},updateAddState:function(e,t,r,i){var s={};for(var o in t)n.extend(s,this.updateAddElementState(e,t[o],r[o],o,i));return s},updateState:function(e,t,n,r){s(!o(t)||!o(n),'the client is outputing empty objects("'+r+'")...these should have been trimmed off'),this.session=e,this.path||(this.path=r,s(this.verifyPath(this.path),"cannot updateState with an invalid collection path")),t=t||{},n=n||{},this.applyStateChanges(this.updateAddState(e,t,n,r),this.updateRemoveState(e,t,n,r))},sync:function(){}};return u}),define("model.btapp",["jquery","backbone","underscore","base.btapp"],function(e,t,n,r){var i=function(e,t){if(!e)throw t},s=function(t){return n.isObject(t)&&!n.isArray(t)&&e.isEmptyObject(t)},o=t.Model.extend(r).extend({initialize:function(){t.Model.prototype.initialize.apply(this,arguments),r.initialize.apply(this,arguments),this.on("change",this.customEvents,this)},destructor:function(){this.off("change",this.customEvents,this),this.trigger("destroy")},clearState:function(){this.initializeValues();var e=n.clone(this.attributes);delete e.id,n.each(e,function(e){e&&n.isObject(e)&&e.hasOwnProperty("clearState")&&e.clearState()}),t.Model.prototype.set.call(this,e,{internal:!0,unset:!0}),this.destructor()},customEvents:function(){var e=this.changedAttributes();n.each(e,n.bind(function(e,t){if(e===undefined){var n=this.previous(t);this.trigger("remove",n,t),this.trigger("remove:"+t,n)}else this.previous(t)===undefined&&(this.trigger("add",e,t),this.trigger("add:"+t,e))},this))},verifyPath:function(){return!0},updateRemoveAttributeState:function(e,t){var n={};return i(this.get(e)===t,"trying to remove an attribute, but did not provide the correct previous value"),n[e]=this.get(e),n},updateAddAttributeState:function(e,t,n,r,s){var o={};return i(this.get(s)!==t,"trying to set a variable to the existing value ["+r+" -> "+JSON.stringify(t)+"]"),n!==undefined&&i(this.get(s)===n,"trying to update an attribute, but did not provide the correct previous value"),o[s]=t,o},isEmpty:function(){var e=n.keys(this.toJSON());return s(this.bt)&&(e.length===0||e.length===1&&e[0]==="id")},applyStateChanges:function(e,n){t.Model.prototype.set.call(this,e,{internal:!0}),t.Model.prototype.set.call(this,n,{internal:!0,unset:!0})},set:function(e,r,i){var s=function(e,t){if(i&&"internal"in i)return;if(n.isUndefined(this.get(t)))return;throw"please use save to set attributes directly to the client"};return n.isObject(e)||e===null?n(e).each(s,this):s.call(this,r,e),t.Model.prototype.set.apply(this,arguments)},save:function(t){var r=[];return n(t).each(function(e,t){r.push(this.bt.set(t,e))},this),e.when.apply(e,r)}});return o}),define("collection.btapp",["jquery","backbone","underscore","base.btapp"],function(e,t,n,r){var i=function(e,t){if(!e)throw t},s=function(t){return n.isObject(t)&&!n.isArray(t)&&e.isEmptyObject(t)},o=t.Collection.extend(r).extend({initialize:function(){t.Collection.prototype.initialize.apply(this,arguments),r.initialize.apply(this,arguments),this.on("add",this.customAddEvent,this),this.on("remove",this.customRemoveEvent,this),this.on("change",this.customChangeEvent,this)},customEvent:function(e,t){if(n.isFunction(t))return;i(t&&t.id,"called a custom "+e+" event without a valid attribute"),this.trigger(e+":"+t.id,t)},customAddEvent:function(e){this.customEvent("add",e)},customRemoveEvent:function(e){this.customEvent("remove",e)},customChangeEvent:function(e){this.customEvent("change",e)},destructor:function(){this.off("add",this.customAddEvent,this),this.off("remove",this.customRemoveEvent,this),this.off("change",this.customChangeEvent,this),this.trigger("destroy")},clearState:function(){this.each(function(e){e.clearState()}),this.initializeValues(),this.reset(),this.destructor()},verifyPath:function(e){var t=[["btapp","torrent"],["btapp","torrent","all","*","file"],["btapp","torrent","all","*","peer"],["btapp","label"],["btapp","label","all","*","torrent"],["btapp","label","all","*","torrent","all","*","file"],["btapp","label","all","*","torrent","all","*","peer"],["btapp","rss"],["btapp","rss","all","*","item"],["btapp","stream"],["btapp","stream","all","*","diskio"]];return n.any(t,function(t){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++){if(t[n]==="*")continue;if(t[n]!==e[n])return!1}return!0})},updateRemoveAttributeState:function(){throw"trying to remove an invalid type from a BtappCollection"},updateAddAttributeState:function(){throw"trying to add an invalid type to a BtappCollection"},isEmpty:function(){return s(this.bt)&&this.length===0},applyStateChanges:function(e,t){this.add(n.values(e)),this.remove(n.values(t))}});return o}),define("btapp",["jquery","underscore","backbone","rpc.btapp","model.btapp","collection.btapp"],function(e,t,n,r,i){var s=function(e,t){if(!e)throw t},o=1e4,u=500,a=500,f=i.extend({initialize:function(){i.prototype.initialize.apply(this,arguments),this.ajax=f.ajax,this.path=["btapp"],this.connectedState=!1,this.rpc=null,this.queries=null,this.session=null,this.lastQuery=null},destructor:function(){},connect:function(e){s(!this.rpc,"trying to connect to an undefined client"),s(!this.connectedState,"trying to connect when already connected"),this.connectedState=!0,s(!this.session,"trying to create another session while one is active"),e=e||{},this.pollFrequency=u,this.queries=e.queries||[["btapp"]];var n="the queries attribute must be an array of arrays of strings";s(t.isArray(this.queries),n),s(t.all(this.queries,function(e){return t.isArray(e)&&t.all(e,function(e){return t.isString(e)})}),n),s(t.has(e,"port"),"port must be specified"),this.rpc=new r(e),this.fetch()},disconnect:function(){this.trigger("disconnect","manual"),s(this.rpc,"trying to disconnect from an undefined client"),s(this.connectedState,"trying to disconnect when not connected"),this.session&&this.rpc.query({type:"disconnect",session:this.session}),this.connectedState=!1,this.lastQuery&&(this.lastQuery.abort(),this.lastQuery=null),this.session=null,this.nextTimeout&&clearTimeout(this.nextTimeout),this.rpc.disconnect(),this.rpc=null,this.queries=null,this.clearState()},connected:function(){return this.connectedState},onConnectionError:function(){this.pollFrequency=o,this.clearState(),this.session=null,this.lastQuery&&(this.lastQuery.abort(),this.lastQuery=null)},onFetch:function(e){s("session"in e,"did not recieve a session id from the client"),this.session=e.session,this.waitForEvents(e.session)},fetch:function(){this.rpc&&(this.lastQuery=this.rpc.query({type:"state",queries:JSON.stringify(this.queries)}).done(t.bind(this.onFetch,this)).fail(t.bind(this.onConnectionError,this)))},onEvent:function(e,t){if("add"in t||"remove"in t)t.add=t.add||{},t.remove=t.remove||{},this.updateState(e,t.add.btapp,t.remove.btapp,["btapp"]);else{if(!("callback"in t))throw"received invalid data from the client";this.rpc.btappCallbacks[t.callback](t.arguments)}},onEvents:function(e,n){s(this.session===e,"should not receive data for a different session after creating a new one. do not forget to abort the last call of your old session.");if(this.connectedState){this.trigger("sync",n),n.length===0?this.pollFrequency=Math.min(o,this.pollFrequency+a):this.pollFrequency=u;for(var r=0;r<n.length;r++)this.onEvent(e,n[r]);clearTimeout(this.nextTimeout),this.nextTimeout=setTimeout(t.bind(this.waitForEvents,this,e),this.pollFrequency)}},waitForEvents:function(e){this.rpc&&(this.lastQuery=this.rpc.query({type:"update",session:e}).done(t.bind(this.onEvents,this,e)).fail(t.bind(this.onConnectionError,this)))}});return f.ajax=e.ajax,f});